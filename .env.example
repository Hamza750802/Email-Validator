# =============================================================================
# ValidR Email Validation Service - Environment Configuration
# =============================================================================
# Copy this file to .env and customize as needed
# Most defaults are production-ready and don't require changes

# -----------------------------------------------------------------------------
# Server Configuration
# -----------------------------------------------------------------------------

# Port the HTTP server listens on
# Render will override this with their PORT environment variable
PORT=4000

# Node environment (development, production, test)
NODE_ENV=production

# Logging level (DEBUG, INFO, WARN, ERROR)
# Use INFO or WARN in production to reduce noise
LOG_LEVEL=INFO

# -----------------------------------------------------------------------------
# SMTP Validation Configuration
# -----------------------------------------------------------------------------
# These settings control how aggressively ValidR probes SMTP servers
# Default values are "polite" to avoid being blocked by mail servers
# ⚠️ IMPORTANT: Use responsibly! Aggressive settings may get your IP blocked

# Maximum concurrent SMTP connections across all domains
# Lower = more polite, higher = faster but riskier
# Range: 1-100, Default: 10
SMTP_MAX_GLOBAL_CONCURRENCY=10

# Maximum concurrent connections per MX server
# Keep this low (1-3) to avoid triggering rate limits
# Range: 1-10, Default: 2
SMTP_MAX_MX_CONCURRENCY=2

# Minimum delay between requests to the same domain (milliseconds)
# Higher = more polite, prevents hammering single domains
# Range: 0+, Default: 2000 (2 seconds)
SMTP_PER_DOMAIN_MIN_INTERVAL_MS=2000

# Number of retries for soft failures (4xx errors)
# Range: 0-5, Default: 2
SMTP_SOFT_RETRY_LIMIT=2

# Initial retry delay after soft failure (milliseconds)
# Range: 1000+, Default: 5000 (5 seconds)
SMTP_INITIAL_RETRY_DELAY_MS=5000

# Exponential backoff multiplier for retries
# Each retry waits (previous_delay * this_factor) milliseconds
# Range: 1-10, Default: 3
SMTP_RETRY_BACKOFF_FACTOR=3

# Timeout for initial SMTP connection (milliseconds)
# Range: 1000-60000, Default: 10000 (10 seconds)
SMTP_CONNECT_TIMEOUT_MS=10000

# Total timeout for entire SMTP validation (milliseconds)
# Must be greater than SMTP_CONNECT_TIMEOUT_MS
# Range: 5000-120000, Default: 15000 (15 seconds)
SMTP_OVERALL_TIMEOUT_MS=15000

# ===== Per-Phase Timeouts (NEW - Granular Failure Detection) =====
# These enable identifying exactly WHERE SMTP connections stall

# Timeout waiting for SMTP banner (220 greeting)
# Range: 1000-30000, Default: 5000 (5 seconds)
SMTP_BANNER_TIMEOUT_MS=5000

# Timeout for EHLO response
# Range: 1000-30000, Default: 5000 (5 seconds)
SMTP_EHLO_TIMEOUT_MS=5000

# Timeout for MAIL FROM response
# Range: 1000-30000, Default: 5000 (5 seconds)
SMTP_MAIL_TIMEOUT_MS=5000

# Timeout for RCPT TO response (the actual validation)
# Range: 1000-30000, Default: 5000 (5 seconds)
SMTP_RCPT_TIMEOUT_MS=5000

# ===== STARTTLS Configuration (Partial Support) =====
# TLS detection implemented, full upgrade TODO

# Require TLS upgrade (reject servers without STARTTLS)
# Default: false (accept plaintext)
SMTP_REQUIRE_TLS=false

# Allow fallback to plaintext if STARTTLS fails
# Default: true (continue without TLS)
SMTP_ALLOW_TLS_DOWNGRADE=true

# ===== MX Probing Strategy (NEW - Improves Success Rate) =====

# Maximum MX hosts to attempt before giving up
# Range: 1-10, Default: 5
# Higher = more resilient but slower failures
SMTP_MAX_MX_ATTEMPTS=5

# Randomize MX hosts within same priority
# Default: true (spreads load across backup MXes)
# Prevents all traffic hitting primary MX
SMTP_RANDOMIZE_SAME_PRIORITY=true

# Domain name to identify yourself in SMTP HELO/EHLO
# Should be a real domain you control (improves trust)
# Some mail servers reject invalid HELO domains
SMTP_HELO_DOMAIN=mail.yourdomain.com

# Email address used in SMTP MAIL FROM command
# Should be a real, deliverable address from your domain
# Some servers verify this exists before accepting RCPT TO
SMTP_MAIL_FROM=verifier@yourdomain.com

# -----------------------------------------------------------------------------
# Deployment Notes
# -----------------------------------------------------------------------------
#
# Render Deployment:
#   - Add these variables in the Render dashboard under "Environment"
#   - Render automatically sets PORT, don't override it
#   - For SMTP_HELO_DOMAIN and SMTP_MAIL_FROM, use your actual domain
#
# Rate Limiting Recommendations:
#   - Start conservative (current defaults are good)
#   - Monitor your logs for 4xx errors or timeouts
#   - Gradually increase concurrency if no issues
#   - If you get blocked, reduce SMTP_MAX_GLOBAL_CONCURRENCY to 5
#
# Responsible Use:
#   - Don't validate the same email repeatedly
#   - Implement your own rate limiting on the API
#   - Consider caching results for 24-48 hours
#   - Respect mail server resources
#
# =============================================================================
