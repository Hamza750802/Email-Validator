# =============================================================================
# ValidR Email Validation Service - Environment Configuration
# =============================================================================
# Copy this file to .env and customize as needed
# Most defaults are production-ready and don't require changes

# -----------------------------------------------------------------------------
# Server Configuration
# -----------------------------------------------------------------------------

# Port the HTTP server listens on
# Render will override this with their PORT environment variable
PORT=4000

# Node environment (development, production, test)
NODE_ENV=production

# Logging level (DEBUG, INFO, WARN, ERROR)
# Use INFO or WARN in production to reduce noise
LOG_LEVEL=INFO

# -----------------------------------------------------------------------------
# SMTP Validation Configuration
# -----------------------------------------------------------------------------
# These settings control how aggressively ValidR probes SMTP servers
# Default values are "polite" to avoid being blocked by mail servers
# ⚠️ IMPORTANT: Use responsibly! Aggressive settings may get your IP blocked

# Maximum concurrent SMTP connections across all domains
# Lower = more polite, higher = faster but riskier
# Range: 1-100, Default: 12
SMTP_MAX_GLOBAL_CONCURRENCY=12

# Maximum concurrent connections per MX server
# Keep this low (1-3) to avoid triggering rate limits
# Range: 1-10, Default: 3
SMTP_MAX_MX_CONCURRENCY=3

# Minimum delay between requests to the same domain (milliseconds)
# Higher = more polite, prevents hammering single domains
# Range: 0+, Default: 1500 (1.5 seconds)
SMTP_PER_DOMAIN_MIN_INTERVAL_MS=1500

# Number of retries for soft failures (4xx errors)
# Range: 0-5, Default: 2
SMTP_SOFT_RETRY_LIMIT=2

# Initial retry delay after soft failure (milliseconds)
# Range: 1000+, Default: 5000 (5 seconds)
SMTP_INITIAL_RETRY_DELAY_MS=5000

# Exponential backoff multiplier for retries
# Each retry waits (previous_delay * this_factor) milliseconds
# Range: 1-10, Default: 3
SMTP_RETRY_BACKOFF_FACTOR=3

# Timeout for initial SMTP connection (milliseconds)
# Range: 1000-60000, Default: 5000 (5 seconds)
SMTP_CONNECT_TIMEOUT_MS=5000

# Total timeout for entire SMTP validation (milliseconds)
# Must be greater than SMTP_CONNECT_TIMEOUT_MS
# Range: 5000-120000, Default: 16000 (16 seconds)
SMTP_OVERALL_TIMEOUT_MS=16000

# ===== Per-Phase Timeouts (NEW - Granular Failure Detection) =====
# These enable identifying exactly WHERE SMTP connections stall

# Timeout waiting for SMTP banner (220 greeting)
# Range: 1000-30000, Default: 4000 (4 seconds)
SMTP_BANNER_TIMEOUT_MS=4000

# Timeout for EHLO response
# Range: 1000-30000, Default: 4000 (4 seconds)
SMTP_EHLO_TIMEOUT_MS=4000

# Timeout for MAIL FROM response
# Range: 1000-30000, Default: 4000 (4 seconds)
SMTP_MAIL_TIMEOUT_MS=4000

# Timeout for RCPT TO response (the actual validation)
# Range: 1000-30000, Default: 4000 (4 seconds)
SMTP_RCPT_TIMEOUT_MS=4000

# ===== STARTTLS Configuration (Partial Support) =====
# TLS detection implemented, full upgrade TODO

# Require TLS upgrade (reject servers without STARTTLS)
# Default: false (accept plaintext)
SMTP_REQUIRE_TLS=false

# Allow fallback to plaintext if STARTTLS fails
# Default: true (continue without TLS)
SMTP_ALLOW_TLS_DOWNGRADE=true

# ===== MX Probing Strategy (NEW - Improves Success Rate) =====

# Maximum MX hosts to attempt before giving up
# Range: 1-10, Default: 3
# Higher = more resilient but slower failures
SMTP_MAX_MX_ATTEMPTS=3

# Randomize MX hosts within same priority
# Default: true (spreads load across backup MXes)
# Prevents all traffic hitting primary MX
SMTP_RANDOMIZE_SAME_PRIORITY=true

# Domain name to identify yourself in SMTP HELO/EHLO
# Should be a real domain you control (improves trust)
# Some mail servers reject invalid HELO domains
SMTP_HELO_DOMAIN=mail.validr.co

# Email address used in SMTP MAIL FROM command
# Should be a real, deliverable address from your domain
# Some servers verify this exists before accepting RCPT TO
SMTP_MAIL_FROM=verifier@validr.co

# -----------------------------------------------------------------------------
# Redis Cache Configuration (Optional)
# -----------------------------------------------------------------------------
# ValidR uses Redis for caching validation results and domain throttling state
# Falls back to in-memory cache if Redis is unavailable

# Enable or disable Redis caching
# Default: true (use Redis if available)
REDIS_ENABLED=true

# Redis connection URL
# Format: redis://[username:password@]host:port[/db]
# Default: redis://localhost:6379
REDIS_URL=redis://localhost:6379

# Key prefix for all Redis keys (prevents conflicts with other apps)
# Default: validr:
REDIS_KEY_PREFIX=validr:

# Cache TTL for validation results (seconds)
# How long to cache email validation results
# Range: 60-86400, Default: 86400 (24 hours)
REDIS_CACHE_TTL_SECONDS=86400

# Throttle state TTL (seconds)
# How long to track per-domain throttling state
# Range: 10-3600, Default: 300 (5 minutes)
REDIS_THROTTLE_TTL_SECONDS=300

# -----------------------------------------------------------------------------
# Deployment Notes
# -----------------------------------------------------------------------------
#
# Webdock/VPS Deployment:
#   - Copy this file to .env on the server
#   - SSH: ssh root@your-server-ip
#   - Navigate to project: cd /var/www/validr
#   - Create .env: nano .env (paste values and save with Ctrl+X, Y, Enter)
#   - Restart: pm2 restart all
#   - Verify: pm2 logs validr --lines 50
#
# Domain Setup (validr.co):
#   - Point A record to your Webdock server IP
#   - Set up mail subdomain: mail.validr.co (A record or CNAME)
#   - Create verifier@validr.co email (or catchall)
#   - Update SMTP_HELO_DOMAIN and SMTP_MAIL_FROM above
#
# Rate Limiting Recommendations:
#   - Start conservative (current defaults are good)
#   - Monitor your logs for 4xx errors or timeouts
#   - Gradually increase concurrency if no issues
#   - If you get blocked, reduce SMTP_MAX_GLOBAL_CONCURRENCY to 5
#
# Responsible Use:
#   - Don't validate the same email repeatedly
#   - Implement your own rate limiting on the API
#   - Consider caching results for 24-48 hours
#   - Respect mail server resources
#
# =============================================================================
